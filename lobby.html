<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
        <title>Croquet Lobby</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 0;
                padding: 0;
            }
            h1 {
                background: #333;
                color: #fff;
                margin: 0;
                padding: 1em;
            }
            ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }
            li {
                background: #eee;
                border-bottom: 1px solid #ccc;
                cursor: pointer;
                padding: 1em;
            }
            li:hover {
                background: #ddd;
            }
            li.current {
                background: #afa;
            }
            li.current:hover {
                background: #cfc;
            }
            iframe {
                position: fixed;
                top: 0;
                left: 0;
                border: none;
                height: 100vh;
                width: 100vw;
                display: none;
            }
            iframe.current {
                display: block;
            }
        </style>
        <!-- <script src="https://cdn.jsdelivr.net/npm/@croquet/croquet@1.1.0-27"></script> -->
        <script src="./croquet.min.js"></script>
    </head>
    <body>
        <h1>Croquet Lobby</h1>
        <ul id="sessions"></ul>
        <iframe id="app" src="about:blank"></iframe>
        <script>

// TODO
// [x] list sessions
// [x] new session button
// [ ] single view as relay
// [ ] hierarchical lobby sessions
// [ ] unlisted sessions (join directly by name)

const BaseUrl = window.location.href.replace(/[^/?#]+([?#].*)?$/, "");
Croquet.Constants.AppUrl = BaseUrl + "index.html";

const appname = BaseUrl.match(/([^/]+)\/?$/, "$1");
if (appname) document.querySelector("h1").textContent = appname[1].replace(/^./, c => c.toUpperCase());

const SESSION_TIMEOUT = 5; // seconds

class Lobby extends Croquet.Model {

    init(_, persisted) {
        this.sessions = new Map();
        this.views = new Map();
        this.subscribe(this.sessionId, "view-join", this.viewJoined);
        this.subscribe(this.sessionId, "view-exit", this.viewExited);
        this.subscribe(this.sessionId, "in-app-session", this.inAppSession);
        this.subscribe(this.sessionId, "left-app-session", this.leftAppSession);
        if (persisted) for (let session of persisted.sessions) {
            this.ensureSession(session.name);
        }
    }

    ensureSession(name, persist=true) {
        let session = this.sessions.get(name);
        if (!session) {
            session = {
                name,
                viewIds: new Set(),
                since: 0,
                lastActive: 0,
            };
            this.sessions.set(name, session);
        }
        this.persistSession({
            sessions: [...this.sessions.values()].map(s => ({ name: s.name })),
        });
        return session;
    }

    viewJoined(viewId) {
        this.views.set(viewId, {
            viewId,
            sessions: new Set(),    // sessions this view is in
            timeouts: new Map(),    // session -> future message
        });
        // console.log("lobby", this.now(), "view joined", viewId, [...this.views.keys()]);
    }

    viewExited(viewId) {
        // console.log("lobby", this.now(), "view exiting", viewId);
        let view = this.views.get(viewId);
        // console.log("lobby", this.now(), "canceling timeouts", viewId, [...view.timeouts.keys()].map(session => session.name));
        for (let [session, timeout] of view.timeouts) {
            const result = this.cancelFuture(timeout);
            // console.log("lobby", this.now(), "cancel timeout", view.viewId, timeout, result);
        }
        // console.log("lobby", this.now(), "leaving", [...view.sessions].map(session => session.name));
        for (let session of view.sessions) {
            this.leftAppSession({ session, view });
        }
        this.views.delete(viewId);
        // console.log("lobby", this.now(), "view exited", viewId, [...this.views.keys()]);
    }

    inAppSession({ viewId, name, now, users }) {
        let view = this.views.get(viewId);
        let session = this.ensureSession(name);
        if (session.viewIds.size === 0) {
            session.since = now;
        }
        session.lastActive = this.now();
        session.users = users;
        if (!session.viewIds.has(viewId)) {
            session.viewIds.add(viewId);
            view.sessions.add(session);
        }
        this.publish(this.sessionId, "session-changed", name);
        let timeout = view.timeouts.get(session);
        if (timeout) this.cancelFuture(timeout);
        timeout = this.future(SESSION_TIMEOUT * 1000).leftAppSession({ session, view });
        view.timeouts.set(session, timeout);
        // console.log("lobby", this.now(), "in app session", session.name, users, [...session.viewIds]);
    }

    leftAppSession({ session, view }) {
        session.viewIds.delete(view.viewId);
        view.sessions.delete(session);
        if (session.viewIds.size === 0) {
            this.sessions.users = "";
        }
        this.publish(this.sessionId, "session-changed", session.name);
        // console.log("lobby", this.now(), "left app session", session.name, view.viewId, [...session.viewIds]);
    }
}
Lobby.register("Lobby");

class LobbyView extends Croquet.View {
    constructor(model) {
        super(model);
        this.model = model;
        this.showSessions();
        this.subscribe(this.sessionId, "session-changed", this.showSessions);
        this.interval = setInterval(() => this.showSessions(), 1000);
        window.onmessage = e => {
            if (e.data && e.data.type === "croquet-lobby") {
                const { name, users } = e.data;
                // console.log("lobby", "in app session", name, users);
                this.publish(this.sessionId, "in-app-session", { viewId: this.viewId, name, now: Date.now(), users });
            }
        }
    }

    joinAppSession(name) {
        if (name === "New Session") {
            name = prompt("Session Name");
            if (!name) return;
        }
        // open app in iframe
        let iframe = document.getElementById("app");
        iframe.src = Croquet.Constants.AppUrl + `?session=${encodeURIComponent(name)}`;
        iframe.classList.add("current");
    }

    showSessions() {
        let sessions = Array.from(this.model.sessions.values());
        sessions.sort((a, b) => b.since - a.since);
        let list = document.getElementById("sessions");
        list.innerHTML = "";
        sessions.unshift({ name: "New Session" });
        for (let session of sessions) {
            let item = document.createElement("li");
            item.textContent = session.name;
            if (session.name === "New Session") {
                item.style.fontWeight = "bold";
            } else {
                if (session.users) {
                    item.textContent += `: ${session.users}`;
                    item.textContent += ` [${Math.ceil((Date.now() - session.since) / 1000)}s,`;
                    item.textContent += ` timeout in ${(SESSION_TIMEOUT - Math.ceil((this.extrapolatedNow() - session.lastActive) / 1000))}s]`;
                }
                if (session.viewIds.has(this.viewId)) {
                    item.classList.add("current");
                }
            }
            item.addEventListener("click", () => this.joinAppSession(session.name));
            list.appendChild(item);
        }
    }

    detach() {
        clearInterval(this.interval);
        window.onmessage = null;
        super.detach();
    }
}

Croquet.Session.join({
    apiKey: '1_i65fcn11n7lhrb5n890hs3dhj11hfzfej57pvlrx', // get your own from croquet.io/keys
    appId: "io.croquet.lobby",
    name: "lobby",
    password: "lobby",
    location: true,
    model: Lobby,
    view: LobbyView,
    autoSleep: false, // fixme â€“ only need to force while game is running and we're the relay?
    tps: 1,
});

        </script>
    </body>
</html>